{"ast":null,"code":"import n from \"queue-microtask\";\n\nfunction t() {\n  return (t = Object.assign || function (n) {\n    for (var t = 1; t < arguments.length; t++) {\n      var e = arguments[t];\n\n      for (var r in e) Object.prototype.hasOwnProperty.call(e, r) && (n[r] = e[r]);\n    }\n\n    return n;\n  }).apply(this, arguments);\n}\n\nfunction e(n, t) {\n  (null == t || t > n.length) && (t = n.length);\n\n  for (var e = 0, r = new Array(t); e < t; e++) r[e] = n[e];\n\n  return r;\n}\n\nfunction r(n, t, e) {\n  if (!n.s) {\n    if (e instanceof o) {\n      if (!e.s) return void (e.o = r.bind(null, n, t));\n      1 & t && (t = e.s), e = e.v;\n    }\n\n    if (e && e.then) return void e.then(r.bind(null, n, t), r.bind(null, n, 2));\n    n.s = t, n.v = e;\n    var i = n.o;\n    i && i(n);\n  }\n}\n\nvar o = function () {\n  function n() {}\n\n  return n.prototype.then = function (t, e) {\n    var o = new n(),\n        i = this.s;\n\n    if (i) {\n      var u = 1 & i ? t : e;\n\n      if (u) {\n        try {\n          r(o, 1, u(this.v));\n        } catch (n) {\n          r(o, 2, n);\n        }\n\n        return o;\n      }\n\n      return this;\n    }\n\n    return this.o = function (n) {\n      try {\n        var i = n.v;\n        1 & n.s ? r(o, 1, t ? t(i) : i) : e ? r(o, 1, e(i)) : r(o, 2, i);\n      } catch (n) {\n        r(o, 2, n);\n      }\n    }, o;\n  }, n;\n}();\n\nfunction i(n) {\n  return n instanceof o && 1 & n.s;\n}\n\nfunction u(n, t, e) {\n  for (var u;;) {\n    var c = n();\n    if (i(c) && (c = c.v), !c) return f;\n\n    if (c.then) {\n      u = 0;\n      break;\n    }\n\n    var f = e();\n\n    if (f && f.then) {\n      if (!i(f)) {\n        u = 1;\n        break;\n      }\n\n      f = f.s;\n    }\n\n    if (t) {\n      var s = t();\n\n      if (s && s.then && !i(s)) {\n        u = 2;\n        break;\n      }\n    }\n  }\n\n  var a = new o(),\n      l = r.bind(null, a, 2);\n  return (0 === u ? c.then(h) : 1 === u ? f.then(v) : s.then(d)).then(void 0, l), a;\n\n  function v(o) {\n    f = o;\n\n    do {\n      if (t && (s = t()) && s.then && !i(s)) return void s.then(d).then(void 0, l);\n      if (!(c = n()) || i(c) && !c.v) return void r(a, 1, f);\n      if (c.then) return void c.then(h).then(void 0, l);\n      i(f = e()) && (f = f.v);\n    } while (!f || !f.then);\n\n    f.then(v).then(void 0, l);\n  }\n\n  function h(n) {\n    n ? (f = e()) && f.then ? f.then(v).then(void 0, l) : v(f) : r(a, 1, f);\n  }\n\n  function d() {\n    (c = n()) ? c.then ? c.then(h).then(void 0, l) : h(c) : r(a, 1, f);\n  }\n}\n\nvar c = \"INIT\",\n    f = \"SUBSCRIBE\",\n    s = \"UNSUBSCRIBE\",\n    a = \"UPDATED\",\n    l = \"SNAPSHOT\",\n    v = \"EXIT\",\n    h = \"TERMINATE\",\n    d = \"object\" == typeof self && self.self === self && self || \"object\" == typeof global && global.global === global && global || \"object\" == typeof window && window.window === window && window;\nd.FCL_REGISTRY = null == d.FCL_REGISTRY ? {} : d.FCL_REGISTRY;\n\nvar R = 0,\n    b = function (n, t, e, r) {\n  return void 0 === r && (r = {}), new Promise(function (o, i) {\n    var u = r.expectReply || !1,\n        c = null != r.timeout ? r.timeout : 5e3;\n    u && c && setTimeout(function () {\n      return i(new Error(\"Timeout: \" + c + \"ms passed without a response.\"));\n    }, c);\n    var f = {\n      to: n,\n      from: r.from,\n      tag: t,\n      data: e,\n      timeout: c,\n      reply: o,\n      reject: i\n    };\n\n    try {\n      d.FCL_REGISTRY[n].mailbox.deliver(f), u || o(!0);\n    } catch (n) {\n      console.error(\"FCL.Actor -- Could Not Deliver Message\", f, n);\n    }\n  });\n},\n    S = function (n) {\n  delete d.FCL_REGISTRY[n];\n},\n    m = function (r, o) {\n  if (void 0 === o && (o = null), null == o && (o = ++R), null != d.FCL_REGISTRY[o]) return o;\n  var i, c;\n  d.FCL_REGISTRY[o] = {\n    addr: o,\n    mailbox: (c = [], {\n      deliver: function (n) {\n        try {\n          return c.push(n), i && (i(c.shift()), i = void 0), Promise.resolve();\n        } catch (n) {\n          return Promise.reject(n);\n        }\n      },\n      receive: function () {\n        return new Promise(function (n) {\n          var t = c.shift();\n          if (t) return n(t);\n          i = n;\n        });\n      }\n    }),\n    subs: new Set(),\n    kvs: {}\n  };\n  var f,\n      s = {\n    self: function () {\n      return o;\n    },\n    receive: function () {\n      return d.FCL_REGISTRY[o].mailbox.receive();\n    },\n    send: function (n, t, e, r) {\n      return void 0 === r && (r = {}), r.from = o, b(n, t, e, r);\n    },\n    sendSelf: function (n, t, e) {\n      d.FCL_REGISTRY[o] && b(o, n, t, e);\n    },\n    broadcast: function (n, t, r) {\n      void 0 === r && (r = {}), r.from = o;\n\n      for (var i, u = function (n, t) {\n        var r;\n\n        if (\"undefined\" == typeof Symbol || null == n[Symbol.iterator]) {\n          if (Array.isArray(n) || (r = function (n, t) {\n            if (n) {\n              if (\"string\" == typeof n) return e(n, void 0);\n              var r = Object.prototype.toString.call(n).slice(8, -1);\n              return \"Object\" === r && n.constructor && (r = n.constructor.name), \"Map\" === r || \"Set\" === r ? Array.from(n) : \"Arguments\" === r || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r) ? e(n, void 0) : void 0;\n            }\n          }(n))) {\n            r && (n = r);\n            var o = 0;\n            return function () {\n              return o >= n.length ? {\n                done: !0\n              } : {\n                done: !1,\n                value: n[o++]\n              };\n            };\n          }\n\n          throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n        }\n\n        return (r = n[Symbol.iterator]()).next.bind(r);\n      }(d.FCL_REGISTRY[o].subs); !(i = u()).done;) b(i.value, n, t, r);\n    },\n    subscribe: function (n) {\n      return null != n && d.FCL_REGISTRY[o].subs.add(n);\n    },\n    unsubscribe: function (n) {\n      return null != n && d.FCL_REGISTRY[o].subs.delete(n);\n    },\n    subscriberCount: function () {\n      return d.FCL_REGISTRY[o].subs.size;\n    },\n    hasSubs: function () {\n      return !!d.FCL_REGISTRY[o].subs.size;\n    },\n    put: function (n, t) {\n      null != n && (d.FCL_REGISTRY[o].kvs[n] = t);\n    },\n    get: function (n, t) {\n      var e = d.FCL_REGISTRY[o].kvs[n];\n      return null == e ? t : e;\n    },\n    delete: function (n) {\n      delete d.FCL_REGISTRY[o].kvs[n];\n    },\n    update: function (n, t) {\n      null != n && (d.FCL_REGISTRY[o].kvs[n] = t(d.FCL_REGISTRY[o].kvs[n]));\n    },\n    keys: function () {\n      return Object.keys(d.FCL_REGISTRY[o].kvs);\n    },\n    all: function () {\n      return d.FCL_REGISTRY[o].kvs;\n    },\n    where: function (n) {\n      return Object.keys(d.FCL_REGISTRY[o].kvs).reduce(function (e, r) {\n        var i;\n        return n.test(r) ? t({}, e, ((i = {})[r] = d.FCL_REGISTRY[o].kvs[r], i)) : e;\n      }, {});\n    },\n    merge: function (n) {\n      void 0 === n && (n = {}), Object.keys(n).forEach(function (t) {\n        return d.FCL_REGISTRY[o].kvs[t] = n[t];\n      });\n    }\n  };\n  return \"object\" == typeof r && (void 0 === (f = r) && (f = {}), r = function (n) {\n    try {\n      var t = function () {\n        var t = u(function () {\n          return 1;\n        }, void 0, function () {\n          return Promise.resolve(n.receive()).then(function (t) {\n            var e = function (e, r) {\n              try {\n                var o = function (e, r) {\n                  try {\n                    var o = function () {\n                      function e() {\n                        return Promise.resolve(f[t.tag](n, t, t.data || {})).then(function () {});\n                      }\n\n                      var r = function () {\n                        if (\"EXIT\" === t.tag) {\n                          var e = function () {\n                            if (\"function\" == typeof f.TERMINATE) return Promise.resolve(f.TERMINATE(n, t, t.data || {})).then(function () {});\n                          }();\n\n                          if (e && e.then) return e.then(function () {});\n                        }\n                      }();\n\n                      return r && r.then ? r.then(e) : e();\n                    }();\n                  } catch (n) {\n                    return r(n);\n                  }\n\n                  return o && o.then ? o.then(void 0, r) : o;\n                }(0, function (e) {\n                  console.error(n.self() + \" Error\", t, e);\n                });\n              } catch (n) {\n                return;\n              }\n\n              return o && o.then ? o.then(r.bind(null, !1), r.bind(null, !0)) : void 0;\n            }(0, function (n, t) {});\n\n            if (e && e.then) return e.then(function () {});\n          });\n        });\n        return t && t.then ? t.then(function () {}) : void 0;\n      },\n          e = function () {\n        if (\"function\" == typeof f.INIT) return Promise.resolve(f.INIT(n)).then(function () {});\n      }();\n\n      return Promise.resolve(e && e.then ? e.then(t) : t());\n    } catch (n) {\n      return Promise.reject(n);\n    }\n  }), n(function () {\n    try {\n      return Promise.resolve(r(s)).then(function () {\n        S(o);\n      });\n    } catch (n) {\n      return Promise.reject(n);\n    }\n  }), o;\n};\n\nfunction I(n, t, e) {\n  t(n);\n  var r = m(function (t) {\n    try {\n      var r;\n      return t.send(n, \"SUBSCRIBE\"), Promise.resolve(u(function () {\n        return !r && 1;\n      }, void 0, function () {\n        return Promise.resolve(t.receive()).then(function (o) {\n          if (\"@EXIT\" === o.tag) return t.send(n, \"UNSUBSCRIBE\"), void (r = 1);\n          e(o.data);\n        });\n      }));\n    } catch (n) {\n      return Promise.reject(n);\n    }\n  });\n  return function () {\n    return b(r, \"@EXIT\");\n  };\n}\n\nfunction E(n, t) {\n  return t(n), b(n, \"SNAPSHOT\", null, {\n    expectReply: !0,\n    timeout: 0\n  });\n}\n\nexport { v as EXIT, c as INIT, l as SNAPSHOT, f as SUBSCRIBE, h as TERMINATE, s as UNSUBSCRIBE, a as UPDATED, S as kill, b as send, E as snapshoter, m as spawn, I as subscriber };","map":{"version":3,"mappings":"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","names":["pact","state","value","s","o","_settle","bind","v","then","observer","_Pact","prototype","onFulfilled","onRejected","result","this","callback","e","_this","thenable","test","update","body","stage","shouldContinue","_isSettledPact","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","INIT","SUBSCRIBE","UNSUBSCRIBE","UPDATED","SNAPSHOT","EXIT","TERMINATE","root","self","global","window","FCL_REGISTRY","pid","send","addr","tag","data","opts","Promise","reply","expectReply","timeout","setTimeout","Error","payload","to","from","mailbox","deliver","error","console","kill","spawn","fn","next","queue","msg","push","shift","undefined","receive","resolve","subs","Set","kvs","handlers","ctx","sendSelf","broadcast","r","done","subscribe","sub","add","unsubscribe","subscriberCount","size","hasSubs","put","key","get","fallback","delete","keys","Object","all","where","reduce","acc","pattern","merge","forEach","letter","finalizer","recover","queueMicrotask","subscriber","address","spawnFn","_exit2","snapshoter"],"sources":["../src/index.js","../src/mailbox/index.js"],"sourcesContent":["import {mailbox as createMailbox} from \"./mailbox\"\nimport queueMicrotask from \"queue-microtask\"\n\nexport const INIT = \"INIT\"\nexport const SUBSCRIBE = \"SUBSCRIBE\"\nexport const UNSUBSCRIBE = \"UNSUBSCRIBE\"\nexport const UPDATED = \"UPDATED\"\nexport const SNAPSHOT = \"SNAPSHOT\"\nexport const EXIT = \"EXIT\"\nexport const TERMINATE = \"TERMINATE\"\n\nconst root =\n  (typeof self === \"object\" && self.self === self && self) ||\n  (typeof global === \"object\" && global.global === global && global) ||\n  (typeof window === \"object\" && window.window === window && window)\n\nroot.FCL_REGISTRY = root.FCL_REGISTRY == null ? {} : root.FCL_REGISTRY\nvar pid = 0b0\n\nconst DEFAULT_TIMEOUT = 5000\nconst DEFAULT_TAG = \"---\"\nexport const send = (addr, tag, data, opts = {}) =>\n  new Promise((reply, reject) => {\n    const expectReply = opts.expectReply || false\n    const timeout = opts.timeout != null ? opts.timeout : DEFAULT_TIMEOUT\n\n    if (expectReply && timeout) {\n      setTimeout(\n        () =>\n          reject(new Error(`Timeout: ${timeout}ms passed without a response.`)),\n        timeout\n      )\n    }\n\n    const payload = {\n      to: addr,\n      from: opts.from,\n      tag,\n      data,\n      timeout,\n      reply,\n      reject,\n    }\n\n    try {\n      root.FCL_REGISTRY[addr].mailbox.deliver(payload)\n      if (!expectReply) reply(true)\n    } catch (error) {\n      console.error(\"FCL.Actor -- Could Not Deliver Message\", payload, error)\n    }\n  })\n\nexport const kill = addr => {\n  delete root.FCL_REGISTRY[addr]\n}\n\nconst fromHandlers = (handlers = {}) => async ctx => {\n  if (typeof handlers[INIT] === \"function\") await handlers[INIT](ctx)\n  __loop: while (1) {\n    const letter = await ctx.receive()\n    try {\n      if (letter.tag === EXIT) {\n        if (typeof handlers[TERMINATE] === \"function\") {\n          await handlers[TERMINATE](ctx, letter, letter.data || {})\n        }\n        break __loop\n      }\n      await handlers[letter.tag](ctx, letter, letter.data || {})\n    } catch (error) {\n      console.error(`${ctx.self()} Error`, letter, error)\n    } finally {\n      continue __loop\n    }\n  }\n}\n\nexport const spawn = (fn, addr = null) => {\n  if (addr == null) addr = ++pid\n  if (root.FCL_REGISTRY[addr] != null) return addr\n\n  root.FCL_REGISTRY[addr] = {\n    addr,\n    mailbox: createMailbox(),\n    subs: new Set(),\n    kvs: {},\n  }\n\n  const ctx = {\n    self: () => addr,\n    receive: () => root.FCL_REGISTRY[addr].mailbox.receive(),\n    send: (to, tag, data, opts = {}) => {\n      opts.from = addr\n      return send(to, tag, data, opts)\n    },\n    sendSelf: (tag, data, opts) => {\n      if (root.FCL_REGISTRY[addr]) send(addr, tag, data, opts)\n    },\n    broadcast: (tag, data, opts = {}) => {\n      opts.from = addr\n      for (let to of root.FCL_REGISTRY[addr].subs) send(to, tag, data, opts)\n    },\n    subscribe: sub => sub != null && root.FCL_REGISTRY[addr].subs.add(sub),\n    unsubscribe: sub => sub != null && root.FCL_REGISTRY[addr].subs.delete(sub),\n    subscriberCount: () => root.FCL_REGISTRY[addr].subs.size,\n    hasSubs: () => !!root.FCL_REGISTRY[addr].subs.size,\n    put: (key, value) => {\n      if (key != null) root.FCL_REGISTRY[addr].kvs[key] = value\n    },\n    get: (key, fallback) => {\n      const value = root.FCL_REGISTRY[addr].kvs[key]\n      return value == null ? fallback : value\n    },\n    delete: key => {\n      delete root.FCL_REGISTRY[addr].kvs[key]\n    },\n    update: (key, fn) => {\n      if (key != null)\n        root.FCL_REGISTRY[addr].kvs[key] = fn(root.FCL_REGISTRY[addr].kvs[key])\n    },\n    keys: () => {\n      return Object.keys(root.FCL_REGISTRY[addr].kvs)\n    },\n    all: () => {\n      return root.FCL_REGISTRY[addr].kvs\n    },\n    where: pattern => {\n      return Object.keys(root.FCL_REGISTRY[addr].kvs).reduce((acc, key) => {\n        return pattern.test(key)\n          ? {...acc, [key]: root.FCL_REGISTRY[addr].kvs[key]}\n          : acc\n      }, {})\n    },\n    merge: (data = {}) => {\n      Object.keys(data).forEach(\n        key => (root.FCL_REGISTRY[addr].kvs[key] = data[key])\n      )\n    },\n  }\n\n  if (typeof fn === \"object\") fn = fromHandlers(fn)\n\n  queueMicrotask(async () => {\n    await fn(ctx)\n    kill(addr)\n  })\n\n  return addr\n}\n\n// Returns an unsubscribe function\n// A SUBSCRIBE handler will need to be created to handle the subscription event\n//\n//  [SUBSCRIBE]: (ctx, letter) => {\n//    ctx.subscribe(letter.from)\n//    ctx.send(letter.from, UPDATED, ctx.all())\n//  }\n//\nexport function subscriber(address, spawnFn, callback) {\n  spawnFn(address)\n  const EXIT = \"@EXIT\"\n  const self = spawn(async ctx => {\n    ctx.send(address, SUBSCRIBE)\n    while (1) {\n      const letter = await ctx.receive()\n      if (letter.tag === EXIT) {\n        ctx.send(address, UNSUBSCRIBE)\n        return\n      }\n      callback(letter.data)\n    }\n  })\n  return () => send(self, EXIT)\n}\n\n// Returns a promise that returns a result\n// A SNAPSHOT handler will need to be created to handle the snapshot event\n//\n//  [SNAPSHOT]: (ctx, letter) => {\n//    letter.reply(ctx.all())\n//  }\n//\nexport function snapshoter(address, spawnFn) {\n  spawnFn(address)\n  return send(address, SNAPSHOT, null, {expectReply: true, timeout: 0})\n}\n","export const mailbox = () => {\n  const queue = []\n  var next\n\n  return {\n    async deliver(msg) {\n      queue.push(msg)\n      if (next) {\n        next(queue.shift())\n        next = undefined\n      }\n    },\n\n    receive() {\n      return new Promise(function innerReceive(resolve) {\n        const msg = queue.shift()\n        if (msg) return resolve(msg)\n        next = resolve\n      })\n    },\n  }\n}\n"]},"metadata":{},"sourceType":"module"}